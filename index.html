<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>中国象棋 · qi</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .top-actions { display:flex; gap:12px; align-items:center; margin:8px 0; }
    .pill { padding:8px 12px; border-radius:999px; border:0; cursor:pointer; }
  </style>
</head>
<body>
  <main id="app" class="app">
    <h1>中国象棋</h1>

    <!-- 模式选择 + 在线人数 -->
    <div class="top-actions" style="flex-wrap:wrap;">
      <button class="pill" id="modePve">玩家 vs AI</button>
      <button class="pill" id="modeAiai">AI vs AI</button>
      <button class="pill" id="modeOnline">玩家在线对战</button>
      <span>在线人数：<b id="onlineCount">0</b></span>
    </div>

    <!-- 控制栏 -->
    <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <label><input type="checkbox" id="aiRedToggle"/> 红方AI</label>
      <label><input type="checkbox" id="aiBlackToggle"/> 黑方AI</label>
      <select id="aiLevel" title="AI难度">
        <option value="easy">简单</option>
        <option value="medium" selected>普通</option>
        <option value="hard">困难</option>
      </select>
      <button id="resetBtn" class="pill">重新开始</button>
      <button id="undoBtn" class="pill">悔棋一步</button>
    </div>

    <div id="board" aria-label="中国象棋棋盘" role="grid"></div>
    <div id="status" aria-live="polite">准备就绪</div>
  </main>

  <!-- 登录与跳转 -->
  <script src="/auth.js"></script>

  <script type="module">
    import '/js/supabase-client.js';
    import { startHeartbeat } from '/js/heartbeat.js';
    import { bootFromURL } from '/js/online-game.js';
    import '/js/online-count.js';
    import '/js/ui-view.js';

    (async () => {
      // 若已登录，显示用户信息并汇报在线心跳
      const { user } = await Auth.me();
      if (user) {
        Auth.mountUserBar(user, { showLobby: true });
        startHeartbeat('lobby');
      }

      const aiRedToggle   = document.getElementById('aiRedToggle');
      const aiBlackToggle = document.getElementById('aiBlackToggle');

      document.getElementById('modePve').onclick = () => {
        aiRedToggle.checked = false;
        aiBlackToggle.checked = true;
        aiRedToggle.dispatchEvent(new Event('change'));
        aiBlackToggle.dispatchEvent(new Event('change'));
      };

      document.getElementById('modeAiai').onclick = () => {
        aiRedToggle.checked = true;
        aiBlackToggle.checked = true;
        aiRedToggle.dispatchEvent(new Event('change'));
        aiBlackToggle.dispatchEvent(new Event('change'));
      };

      document.getElementById('modeOnline').onclick = async () => {
        const { user } = await Auth.me();
        if (!user) {
          const next = encodeURIComponent('/mode.html');
          location.href = `/login.html?next=${next}`;
          return;
        }
        location.href = '/mode.html';
      };

      // 支持通过 URL 直接进入对战
      bootFromURL();
    })();
  </script>
</body>
</html>
